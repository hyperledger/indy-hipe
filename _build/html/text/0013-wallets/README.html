

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Summary &mdash; Indy Project Enhancements  documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> Indy Project Enhancements
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../0011-cred-revocation/README.html">HIPE 0011-cred-revocation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../0011-cred-revocation/README.html#motivation">Motivation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../0011-cred-revocation/README.html#tutorial">Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../0011-cred-revocation/README.html#reference">Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../0011-cred-revocation/README.html#drawbacks">Drawbacks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../0011-cred-revocation/README.html#rationale-and-alternatives">Rationale and alternatives</a></li>
<li class="toctree-l1"><a class="reference internal" href="../0011-cred-revocation/README.html#prior-art">Prior art</a></li>
<li class="toctree-l1"><a class="reference internal" href="../0011-cred-revocation/README.html#unresolved-questions">Unresolved questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../0012-concurrency-improvement/README.html">Summary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../0012-concurrency-improvement/README.html#motivation">Motivation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../0012-concurrency-improvement/README.html#tutorial">Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../0012-concurrency-improvement/README.html#reference">Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../0012-concurrency-improvement/README.html#drawbacks">Drawbacks</a></li>
<li class="toctree-l1"><a class="reference internal" href="../0012-concurrency-improvement/README.html#rationale-and-alternatives">Rationale and alternatives</a></li>
<li class="toctree-l1"><a class="reference internal" href="../0012-concurrency-improvement/README.html#prior-art">Prior art</a></li>
<li class="toctree-l1"><a class="reference internal" href="../0012-concurrency-improvement/README.html#unresolved-questions">Unresolved questions</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Indy Project Enhancements</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
      <li>Summary</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../../_sources/text/0013-wallets/README.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <ul class="simple">
<li>Name: wallets</li>
<li>Author: Daniel Hardman, Darko Kulic, Vyacheslav Gudkov, Mike Lodder</li>
<li>Start Date: 2018-05-22</li>
<li>PR: (leave this empty)</li>
<li>Jira Issue: (leave this empty)</li>
</ul>
<div class="section" id="summary">
<span id="summary"></span><h1>Summary<a class="headerlink" href="#summary" title="Permalink to this headline">¶</a></h1>
<p>Specify the external interfaces of identity wallets in the Indy ecosystem, as well
as some background concepts, theory, tradeoffs, and internal implementation guidelines.</p>
<p><img alt="identity wallet" src="../../_images/identity-wallet.png" /></p>
</div>
<div class="section" id="motivation">
<span id="motivation"></span><h1>Motivation<a class="headerlink" href="#motivation" title="Permalink to this headline">¶</a></h1>
<p>Wallets are a familiar component metaphor that SSI has adopted from the world of
cryptocurrencies. The translation isn’t perfect, though; crypto wallets have only a
subset of the features that an identity wallet needs. This causes problems, as
coders may approach wallets in Indy with assumptions that are more narrow than
our actual design target.</p>
<p>Since wallets are a major vector for hacking and cybersecurity issues, casual or
fuzzy wallet requirements are a recipe for frustration or disaster. Divergent
and substandard implementations could undermine security more broadly. This
argues for as much design guidance and implementation help as possible.</p>
<p>Wallets are also a unit of identity portability–if an identity owner doesn’t
like how her software is working, she should be able to exercise her self-
sovereignty by taking the contents of her wallet to a new service. This implies
that wallets need certain types of interoperability in the ecosystem, if they
are to avoid vendor lock-in.</p>
<p>All of these reasons–to clarify design scope, to provide uniform high security, and
to guarantee interop–suggest that we need a formal HIPE to document wallet
architecture.</p>
</div>
<div class="section" id="tutorial">
<span id="tutorial"></span><h1>Tutorial<a class="headerlink" href="#tutorial" title="Permalink to this headline">¶</a></h1>
<p>(For a slide deck that gives a simplified overview of all the content in this
HIPE, please see <a class="reference external" href="http://bit.ly/2JUcIiT">http://bit.ly/2JUcIiT</a>. The deck also
includes a link to a recorded presentation, if you prefer something verbal
and interactive.)</p>
<div class="section" id="what-is-an-identity-wallet">
<span id="what-is-an-identity-wallet"></span><h2>What Is an Identity Wallet?<a class="headerlink" href="#what-is-an-identity-wallet" title="Permalink to this headline">¶</a></h2>
<p>Informally, an <strong>identity wallet</strong> (preferably not just “wallet”) is a digital
container for data that’s needed <em>to control a self-sovereign identity</em>. We
borrow this metaphor from physical wallets:</p>
<p><img alt="physical wallet" src="../../_images/physical-wallet.png" /></p>
<p>Notice that we do not carry around in a physical wallet every document, key, card,
photo, piece of currency, or credential that we possess. A wallet is a mechanism
of <em>convenient control</em>, not an exhaustive repository. A wallet is <em>portable</em>.
A wallet is <em>worth safeguarding</em>. Good wallets are <em>organized so we can find
things easily</em>. A wallet has a <em>physical location</em>.</p>
<p>What does suggest about <em>identity wallets</em>?</p>
</div>
<div class="section" id="types-of-sovereign-data">
<span id="types-of-sovereign-data"></span><h2>Types of Sovereign Data<a class="headerlink" href="#types-of-sovereign-data" title="Permalink to this headline">¶</a></h2>
<p>Before we give a definitive answer to that question, let’s take a detour for a
moment to consider digital data. Actors in a self-sovereign identity ecosystem
may own or control many different types of data:</p>
<ul class="simple">
<li>encryption and signing keys</li>
<li>payment keys</li>
<li>link secrets</li>
<li>PII about themselves or others</li>
<li>credentials</li>
<li>personal documents (e.g., last year’s tax filing, journal, love letters)</li>
<li>digital breadcrumbs (e.g., purchase history)</li>
<li>photos and videos</li>
<li>receipts</li>
<li>health records</li>
</ul>
<p>…and much more. Different subsets of data may be worthy of different
protection efforts:</p>
<p><img alt="the data risk continuum" src="../../_images/risk-continuum.png" /></p>
<p>The data can also show huge variety in its size and in its richness:</p>
<p><img alt="data size and richness" src="../../_images/size-richness.png" /></p>
<p>Because of the sensitivity difference, the size and richness difference, joint
ownership, and different needs for access in different circumstances, we may
store digital data in many different locations, with different backup regimes,
different levels of security, and different cost profiles.</p>
</div>
<div class="section" id="what-s-out-of-scope">
<span id="what-s-out-of-scope"></span><h2>What’s Out of Scope<a class="headerlink" href="#what-s-out-of-scope" title="Permalink to this headline">¶</a></h2>
<div class="section" id="not-a-vault">
<span id="not-a-vault"></span><h3>Not a Vault<a class="headerlink" href="#not-a-vault" title="Permalink to this headline">¶</a></h3>
<p>This variety suggests that an identity wallet as a loose grab-bag of all our
digital “stuff” will give us a poor design. We won’t be able to make good
tradeoffs that satisfy everybody; some will want rigorous, optimized search;
others will want to minimize storage footprint; others will be concerned about
maximizing security.</p>
<p>We reserve the term <strong>vault</strong> to refer to the complex collection of all an
identity owner’s data:</p>
<p><img alt="not a vault" src="../../_images/not-vault.png" /></p>
<p>Note that a vault can <em>contain</em> an identity wallet. A vault is an important
construct, and we may want to formalize its interface. But that is not the
subject of this spec.</p>
</div>
<div class="section" id="not-a-cryptocurrency-wallet">
<span id="not-a-cryptocurrency-wallet"></span><h3>Not A Cryptocurrency Wallet<a class="headerlink" href="#not-a-cryptocurrency-wallet" title="Permalink to this headline">¶</a></h3>
<p>The cryptocurrency community has popularized the term “wallet”–and because
identity wallets share with crypto wallets both high-tech crypto and a need
to store secrets, it is tempting to equate these two concepts. However, an
identity wallet can hold more than just cryptocurrency keys, just as a physical
wallet can hold more than paper currency. Also, identity wallets may need to
manage hundreds of millions of relationships (in the case of large organizations),
whereas most crypto wallets manage a small number of keys:</p>
<p><img alt="not a crypto wallet" src="../../_images/not-crypto-wallet.png" /></p>
</div>
<div class="section" id="not-a-gui">
<span id="not-a-gui"></span><h3>Not a GUI<a class="headerlink" href="#not-a-gui" title="Permalink to this headline">¶</a></h3>
<p>As used in this spec, an identity wallet is not a visible application, but
rather a data store. Although user interfaces (superb ones!) can and should
be layered on top of wallets, from indy’s perspective the wallet itself
consists of a container and its data; its friendly face is a separate
construct. We may casually refer to an application as a “wallet”, but what
we really mean is that the application provides an interface to the
underlying wallet.</p>
<p>This is important because if a user changes which app manages his identity,
he should be able to retain the wallet data itself. We are aiming for a
better portability story than browsers offer (where if you change browsers,
you may be able to export+import your bookmarks, but you have to rebuild
all sessions and logins from scratch).</p>
</div>
</div>
<div class="section" id="personas">
<span id="personas"></span><h2>Personas<a class="headerlink" href="#personas" title="Permalink to this headline">¶</a></h2>
<p>Wallets have many stakeholders. However, three categories of wallet users are
especially impactful on design decisions, so we define a persona for each.</p>
<div class="section" id="alice-individual-identity-owner">
<span id="alice-individual-identity-owner"></span><h3>Alice (individual identity owner)<a class="headerlink" href="#alice-individual-identity-owner" title="Permalink to this headline">¶</a></h3>
<p><img alt="Alice" src="../../_images/alice.png" /></p>
<p>Alice owns several devices, and she has an agent in the cloud. She has a
thousand relationships–some with institutions, some with other people. She
has a couple hundred credentials. She owns three different types of
cryptocurrency. She doesn’t issue or revoke credentials–she just uses them.
She receives proofs from other entities (people and orgs). Her main tool for
exercising a self-sovereign identity is an app on a mobile device.</p>
</div>
<div class="section" id="faber-intitutional-identity-owner">
<span id="faber-intitutional-identity-owner"></span><h3>Faber (intitutional identity owner)<a class="headerlink" href="#faber-intitutional-identity-owner" title="Permalink to this headline">¶</a></h3>
<p><img alt="Faber" src="../../_images/faber.png" /></p>
<p>Faber College has an on-prem data center as well as many resources and
processes in public and private clouds. It has relationships with a million
students, alumni, staff, former staff, applicants, business partners,
suppliers, and so forth. Faber issues credentials and must manage their
revocation. Faber may use crypto tokens to sell and buy credentials and
proofs.</p>
</div>
<div class="section" id="the-org-book-trust-hub">
<span id="the-org-book-trust-hub"></span><h3>The Org Book (trust hub)<a class="headerlink" href="#the-org-book-trust-hub" title="Permalink to this headline">¶</a></h3>
<p><img alt="The Org Book" src="../../_images/trust-hub.png" /></p>
<p>The Org Book holds credentials (business licenses, articles of incorporation,
health permits, etc) issued by various government agencies, about millions
of other business entities. It needs to index and search credentials quickly.
Its data is public. It serves as a reference for many relying parties–thus its
trust hub role.</p>
</div>
</div>
<div class="section" id="use-cases">
<span id="use-cases"></span><h2>Use Cases<a class="headerlink" href="#use-cases" title="Permalink to this headline">¶</a></h2>
<p>The specific uses cases for an identity wallet are too numerous to fully
list, but we can summarize them as follows:</p>
<p><em>As an identity owner (any of the <a class="reference external" href="#personas">personas</a> above), I want to
manage identity and its relationships in a way that guarantees security and
privacy:</em></p>
<ul class="simple">
<li>Create an identity</li>
<li>Setup protective policies</li>
<li>Govern agents</li>
<li>Connect and interact with others</li>
<li>Recover and revoke</li>
<li>Take an identity somewhere else</li>
</ul>
</div>
<div class="section" id="managing-secrets">
<span id="managing-secrets"></span><h2>Managing Secrets<a class="headerlink" href="#managing-secrets" title="Permalink to this headline">¶</a></h2>
<p>Certain sensitive things require special handling. We would never expect to casually
lay an <em>ebola zaire</em> sample on the counter in our bio lab; rather, it must never
leave a special controlled isolation chamber.</p>
<p><img alt="ebola photo by UNMEER, by-nd 2.0, https://www.flickr.com/photos/unmeer/16269824979" src="../../_images/ebola.png" /></p>
<p>Cybersecurity in wallets can be greatly enhanced if we take a similar tack with
high-value secrets. We prefer to generate such secrets in their final resting place,
possibly using a seed if we need determinism. We only use such secrets in their safe
place, instead of passing them out to untrusted parties.</p>
<p>TPMs, HSMs, and so forth follow these rules. Indy’s current wallet interface does,
too. You can’t get private keys out.</p>
</div>
<div class="section" id="composition">
<span id="composition"></span><h2>Composition<a class="headerlink" href="#composition" title="Permalink to this headline">¶</a></h2>
<p>The foregoing discussions about cybersecurity, the desirability of design guidance
and careful implementation, and wallet data that includes but is not limited to
secrets motivates the following logical organization of identity wallets in Indy:</p>
<p><img alt="wallet composition" src="../../_images/composition.png" /></p>
<p>The world outside a wallet interfaces with the wallet through a public interface
provided by indy-sdk, and implemented only once. This is the block labeled
<code class="docutils literal notranslate"><span class="pre">encryption,</span> <span class="pre">query</span> <span class="pre">(wallet</span> <span class="pre">core)</span></code> in the diagram. The implementation in this layer
guarantees proper encryption and secret-handling. It also provides some <a class="reference external" href="#tags-and-queries">query
features</a>.
Records (items) to be stored in a wallet are referenced by a public handle if they are secrets.
This public handle might be a public key in a key pair, for example. Records that are
not secrets can be returned directly across the API boundary.</p>
<p>Underneath, this common wallet code in libindy is supplemented with pluggable storage–
a technology that provides persistence and query features. This pluggable storage could
be a file system, an object store, an RDBMS, a NoSQL DB, a Graph DB, a key~value store,
or almost anything similar. The pluggable storage is registered with the wallet layer
by providing a series of C-callable functions (callbacks). The
storage layer doesn’t have to worry about encryption at all; by the time data reaches
it, it is encrypted robustly, and the layer above the storage takes care of translating
queries to and from encrypted form for external consumers of the wallet.</p>
</div>
<div class="section" id="tags-and-queries">
<span id="tags-and-queries"></span><h2>Tags and Queries<a class="headerlink" href="#tags-and-queries" title="Permalink to this headline">¶</a></h2>
<p>Searchability in wallets is facilitated with a tagging mechanism. Each item in a wallet
can be associated with zero or more tags, where a tag is a <code class="docutils literal notranslate"><span class="pre">key=value</span></code> pair. Items
can be searched based on the tags associated with them, and tag values can be strings
or numbers. With a good inventory of tags in a wallet, searching can be robust and
efficient–but there is no support for joins, subqueries, and other RDBMS-like
constructs, as this would constrain the type of storage plugin that could be written.</p>
<p>An example of the tags on a wallet item that is a credential might be:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>  <span class="n">item</span><span class="o">-</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;My Driver&#39;s License&quot;</span>
  <span class="n">date</span><span class="o">-</span><span class="n">issued</span> <span class="o">=</span> <span class="s2">&quot;2018-05-23&quot;</span>
  <span class="n">issuer</span><span class="o">-</span><span class="n">did</span> <span class="o">=</span> <span class="s2">&quot;ABC&quot;</span>
  <span class="n">schema</span> <span class="o">=</span> <span class="s2">&quot;DEF&quot;</span>
</pre></div>
</div>
<p>Tag names and tag values are both case-sensitive.</p>
<p>Because tag values are normally <a class="reference external" href="#encryption">encrypted</a>, most tag values can only be tested
using the <code class="docutils literal notranslate"><span class="pre">$eq</span></code>, <code class="docutils literal notranslate"><span class="pre">$neq</span></code> or <code class="docutils literal notranslate"><span class="pre">$in</span></code> operators (see <a class="reference external" href="#wallet-query-language">Wallet Query Language</a>,
next). However, it is possible to force a tag to be stored in the wallet as plain text
by naming it with a special prefix, <code class="docutils literal notranslate"><span class="pre">~</span></code> (tilde). This enables operators like <code class="docutils literal notranslate"><span class="pre">$gt</span></code>, <code class="docutils literal notranslate"><span class="pre">$lt</span></code>, and <code class="docutils literal notranslate"><span class="pre">$like</span></code>.
Such tags lose their security guarantees but provide for richer queries; it is up to
applications and their users to decide whether the tradeoff is appropriate.</p>
</div>
<div class="section" id="wallet-query-language">
<span id="wallet-query-language"></span><h2>Wallet Query Language<a class="headerlink" href="#wallet-query-language" title="Permalink to this headline">¶</a></h2>
<p>Wallets can be searched and filtered using a simple, JSON-based query language. We call
this Wallet Query Language (WQL). WQL is designed to require no fancy parsing by
storage plugins, and to be easy enough for developers to learn in just a few minutes.
It is inspired by MongoDB’s query syntax, and can be mapped to SQL, GraphQL, and other
query languages supported by storage backends, with minimal effort.</p>
<p>Formal definition of WQL language is the following:</p>
<div class="highlight-Rust notranslate"><div class="highlight"><pre><span></span><span class="n">query</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">subquery</span><span class="p">}</span><span class="w"></span>
<span class="n">subquery</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="n">subquery</span><span class="p">,</span><span class="w"> </span><span class="p">...,</span><span class="w"> </span><span class="n">subquery</span><span class="p">}</span><span class="w"> </span><span class="c1">// means subquery AND ... AND subquery</span>
<span class="n">subquery</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="cp">$or</span>: <span class="p">[{</span><span class="n">subquery</span><span class="p">},...,</span><span class="w"> </span><span class="p">{</span><span class="n">subquery</span><span class="p">}]</span><span class="w"> </span><span class="c1">// means subquery OR ... OR subquery</span>
<span class="n">subquery</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="cp">$not</span>: <span class="p">{</span><span class="n">subquery</span><span class="p">}</span><span class="w"> </span><span class="c1">// means NOT (subquery)</span>
<span class="n">subquery</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;tagName&quot;</span>: <span class="nc">tagValue</span><span class="w"> </span><span class="c1">// means tagName == tagValue</span>
<span class="n">subquery</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;tagName&quot;</span>: <span class="p">{</span><span class="cp">$neq</span>: <span class="nc">tagValue</span><span class="p">}</span><span class="w"> </span><span class="c1">// means tagName != tagValue</span>
<span class="n">subquery</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;tagName&quot;</span>: <span class="p">{</span><span class="cp">$gt</span>: <span class="nc">tagValue</span><span class="p">}</span><span class="w"> </span><span class="c1">// means tagName &gt; tagValue</span>
<span class="n">subquery</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;tagName&quot;</span>: <span class="p">{</span><span class="cp">$gte</span>: <span class="nc">tagValue</span><span class="p">}</span><span class="w"> </span><span class="c1">// means tagName &gt;= tagValue</span>
<span class="n">subquery</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;tagName&quot;</span>: <span class="p">{</span><span class="cp">$lt</span>: <span class="nc">tagValue</span><span class="p">}</span><span class="w"> </span><span class="c1">// means tagName &lt; tagValue</span>
<span class="n">subquery</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;tagName&quot;</span>: <span class="p">{</span><span class="cp">$lte</span>: <span class="nc">tagValue</span><span class="p">}</span><span class="w"> </span><span class="c1">// means tagName &lt;= tagValue</span>
<span class="n">subquery</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;tagName&quot;</span>: <span class="p">{</span><span class="cp">$like</span>: <span class="nc">tagValue</span><span class="p">}</span><span class="w"> </span><span class="c1">// means tagName LIKE tagValue</span>
<span class="n">subquery</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;tagName&quot;</span>: <span class="p">{</span><span class="cp">$in</span>: <span class="p">[</span><span class="n">tagValue</span><span class="p">,</span><span class="w"> </span><span class="p">...,</span><span class="w"> </span><span class="n">tagValue</span><span class="p">]}</span><span class="w"> </span><span class="c1">// means tagName IN (tagValue, ..., tagValue)</span>
</pre></div>
</div>
<div class="section" id="sample-wql-query-1">
<span id="sample-wql-query-1"></span><h3>Sample WQL Query 1<a class="headerlink" href="#sample-wql-query-1" title="Permalink to this headline">¶</a></h3>
<p>Get all credentials where subject like ‘Acme%’ and issue_date &gt; last week. (Note here
that the name of the issue date tag begins with a tilde, telling the wallet to store its
value unencrypted, which makes the <code class="docutils literal notranslate"><span class="pre">$gt</span></code> operator possible.)</p>
<div class="highlight-JSON notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="nt">&quot;subject&quot;</span><span class="p">:</span> <span class="p">{</span><span class="nt">&quot;$like&quot;</span><span class="p">:</span> <span class="s2">&quot;Acme%&quot;</span><span class="p">},</span>
  <span class="nt">&quot;~issue_date&quot;</span><span class="p">:</span> <span class="p">{</span><span class="nt">&quot;$gt&quot;</span><span class="p">:</span> <span class="mi">2018-06-01</span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="sample-wql-query-2">
<span id="sample-wql-query-2"></span><h3>Sample WQL Query 2<a class="headerlink" href="#sample-wql-query-2" title="Permalink to this headline">¶</a></h3>
<p>Get all credentials about me where schema in (a, b, c) and issuer in (d, e, f).</p>
<div class="highlight-JSON notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="nt">&quot;schema_id&quot;</span><span class="p">:</span> <span class="p">{</span><span class="nt">&quot;$in&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="s2">&quot;c&quot;</span><span class="p">]},</span>
  <span class="nt">&quot;issuer_id&quot;</span><span class="p">:</span> <span class="p">{</span><span class="nt">&quot;$in&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;d&quot;</span><span class="p">,</span> <span class="s2">&quot;e&quot;</span><span class="p">,</span> <span class="s2">&quot;f&quot;</span><span class="p">]},</span>
  <span class="nt">&quot;holder_role&quot;</span><span class="p">:</span> <span class="s2">&quot;self&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="encryption">
<span id="encryption"></span><h2>Encryption<a class="headerlink" href="#encryption" title="Permalink to this headline">¶</a></h2>
<p>Wallets need very robust encryption. However, they must also be searchable, and
the encryption must be equally strong regardless of which storage technology is used.
We want to be able to hide data patterns in the encrypted data, such that an attacker
cannot see common prefixes on keys, or common fragments of data in encrypted values.
And we want to rotate the key that protects a wallet without having to
re-encrypt all its content. This suggests that a trivial encryption scheme,
where we pick a symmetric key and encrypt everything with it, is not adequate.</p>
<p>Instead, wallet encryption takes the following approach:</p>
<ul class="simple">
<li>For attributes of items that are searchable  (<code class="docutils literal notranslate"><span class="pre">type</span></code>, <code class="docutils literal notranslate"><span class="pre">id</span></code>, <code class="docutils literal notranslate"><span class="pre">tag_name</span></code>,
<code class="docutils literal notranslate"><span class="pre">tag_value</span></code>):<ul>
<li>The same input produces the same output.</li>
<li>Every attribute “column” has its own key. That is, there’s an encryption key for
all <code class="docutils literal notranslate"><span class="pre">type</span></code> attributes, a different encryption key for all <code class="docutils literal notranslate"><span class="pre">id</span></code> attributes,
and so forth.</li>
<li>Initialization vector is HMAC-256 value of the field being encrypted.</li>
<li>Two more keys are needed for HMAC–one for <code class="docutils literal notranslate"><span class="pre">type</span></code> and <code class="docutils literal notranslate"><span class="pre">id</span></code> and one for
<code class="docutils literal notranslate"><span class="pre">tag_name</span></code> and <code class="docutils literal notranslate"><span class="pre">tag_value</span></code>.</li>
</ul>
</li>
<li>For item values:<ul>
<li>A new value key is generated for each item value.</li>
<li>Value key is encrypted using key for that field. (Value key also has a “column”
key that contributes to its encryption.)</li>
<li>Initialization vector is generated every time for both encryptions.</li>
</ul>
</li>
<li>For wallet keys:<ul>
<li>Encrypted with master key with random initialization vector.</li>
</ul>
</li>
</ul>
<p>The 7 “column” keys are concatenated and encrypted with a wallet <strong>master key</strong>,
then saved into the metadata of the wallet. This allows the master key to be rotated
without re-encrypting all the items in the wallet.</p>
<p>Today, all encryption is done using ChaCha20-Poly1305, with HMAC-SHA256. This is a solid,
secure encryption algorithm, well tested and widely supported. However, we anticipate the desire
to use different cipher suites, so in the future we will make the cipher suite pluggable.</p>
<p>The way the individual fields are encrypted is shown in the following diagram. Here,
data is shown as if stored in a relational database with tables. Wallet storage may
or may not use tables, but regardless of how the storage distributes and divides the
data, the logical relationships and the encryption shown in the diagram apply.</p>
<p><img alt="encryption" src="../../_images/encryption-schema.png" /></p>
</div>
<div class="section" id="pluggable-storage">
<span id="pluggable-storage"></span><h2>Pluggable Storage<a class="headerlink" href="#pluggable-storage" title="Permalink to this headline">¶</a></h2>
<p>Although Indy infrastructure will provide only one wallet implementation it will allow
to plug different storages for covering of different use cases. Default storage shipped
with libindy will be sqlite based and well suited for agents running on edge devices.
The API endpoint <code class="docutils literal notranslate"><span class="pre">register_wallet_storage</span></code> will allow Indy Developers to register
a custom storage implementation as a set of handlers.</p>
<p>A storage implementation does not need any special security features. It stores data that
was already encrypted by libindy (or data that needs no encryption/protection, in the
case of unencrypted tag values). It searches data in whatever form it is persisted, without
any translation. It returns data as persisted, and lets the common wallet infrastructure
in libindy decrypt it before return it to the user.</p>
</div>
<div class="section" id="secure-enclaves">
<span id="secure-enclaves"></span><h2>Secure Enclaves<a class="headerlink" href="#secure-enclaves" title="Permalink to this headline">¶</a></h2>
<p>Secure Enclaves are purposely designed to manage, generate, and securely store cryptographic
material. Enclaves can be either specially designed hardware (e.g. HSM, TPM) or trusted execution
environments (TEE) that isolate code and data from operating systems (e.g. Intel SGX, AMD SVE,
ARM Trustzone). Enclaves can replace common cryptographic operations that wallets perform (e.g.
encryption, signing). Some secrets cannot be stored in wallets like the key that encrypts the
wallet itself or keys that are backed up. These cannot be stored in enclaves as keys stored in
enclaves cannot be extracted. Enclaves can still protect these secrets via a mechanism called
<strong>wrapping</strong>.</p>
<div class="section" id="enclave-wrapping">
<span id="enclave-wrapping"></span><h3>Enclave Wrapping<a class="headerlink" href="#enclave-wrapping" title="Permalink to this headline">¶</a></h3>
<p>Suppose I have a secret, X, that needs maximum protection. However, I can’t
store X in my secure enclave because I need to use it for operations that
the enclave can’t do for me; I need direct access. So how to I extend
enclave protections to encompass my secret?</p>
<p>I ask the secure enclave to generate a key, Y, that will be used to protect X.
Y is called a <strong>wrapping key</strong>. I give X to the secure enclave and ask that it be
encrypted with wrapping key Y. The enclave returns X’ (ciphertext of X, now
called a <strong>wrapped secret</strong>), which I can leave on disk with confidence; it
cannot be decrypted to X without involving the secure enclave. Later, when
I want to decrypt, I give wrapped secret X’ to the secure enclave and ask it
to give me back X by decrypting with wrapping key Y.</p>
<p><img alt="enclave secret wrapping" src="../../_images/enclave-wrapping.png" /></p>
<p>You could ask whether this really increases security. If you can get into the
enclave, you can wrap or unwrap at will.</p>
<p>The answer is that an unwrapped secret is protected by only one thing–whatever
ACLs exist on the filesystem or storage where it resides. A wrapped secret is
protected by two things–the ACLs and the enclave. OS access may breach either
one, but pulling a hard drive out of a device will not breach the enclave.</p>
</div>
</div>
<div class="section" id="paper-wallets">
<span id="paper-wallets"></span><h2>Paper Wallets<a class="headerlink" href="#paper-wallets" title="Permalink to this headline">¶</a></h2>
<p>It is possible to persist wallet data to physical paper (or, for that matter, to
etched metal or other physical media) instead of a digital container. Such
data has attractive storage properties (e.g., may survive natural disasters,
power outages, and other challenges that would destroy digital data). Of course,
by leaving the digital realm, the data loses its accessibility over standard APIs.</p>
<p>We anticipate that paper wallets will play a role in backup and recovery, and
possibly in enabling SSI usage by populations that lack easy access to smartphones
or the internet. Our wallet design should be friendly to such usage, but physical
persistence of data is beyond the scope of Indy’s plugin storage model and thus
not explored further in this HIPE.</p>
</div>
<div class="section" id="backup-and-recovery">
<span id="backup-and-recovery"></span><h2>Backup and Recovery<a class="headerlink" href="#backup-and-recovery" title="Permalink to this headline">¶</a></h2>
<p>Wallets need a backup and recovery feature, and also a way to export data and
import it. Indy’s wallet API includes an export function and an import function
that may be helpful in such use cases. Today, the export is unfiltered–all data
is exported. The import is also all-or-nothing and must be to an empty wallet;
it is not possible to import selectively or to update existing records during
import.</p>
<p>A future version of import and export may add filtering, overwrite, and progress
callbacks. It may also allow supporting or auxiliary data (other than what the
wallet directly persists) to be associated with the export/import payload.</p>
<p>For technical details on how export and import work, please see the <a class="reference external" href="https://github.com/hyperledger/indy-sdk/tree/master/doc/design/009-wallet-export-import">internal
design docs</a>.</p>
</div>
</div>
<div class="section" id="reference">
<span id="reference"></span><h1>Reference<a class="headerlink" href="#reference" title="Permalink to this headline">¶</a></h1>
<ul class="simple">
<li><a class="reference external" href="https://github.com/hyperledger/indy-sdk/tree/master/doc/design/003-wallet-storage">Wallet Design</a></li>
</ul>
</div>
<div class="section" id="rationale-and-alternatives">
<span id="rationale-and-alternatives"></span><h1>Rationale and alternatives<a class="headerlink" href="#rationale-and-alternatives" title="Permalink to this headline">¶</a></h1>
<p>We could implement wallets purely as built already in the cryptocurrency world.
This would give us great security (except for crypto wallets that are cloud based),
and perhaps moderately good usability.</p>
<p>However, it would also mean we could not store credentials in wallets. Indy would
then need an alternate mechanism to scan some sort of container when trying to
satisfy a proof request. And it would mean that a person’s identity would not be
portable via a single container; rather, if you wanted to take your identity to a
new place, you’d have to copy all crypto keys in your crypto wallet, plus copy all
your credentials using some other mechanism. It would also fragment the places where
you could maintain an audit trail of your SSI activities.</p>
</div>
<div class="section" id="prior-art">
<span id="prior-art"></span><h1>Prior art<a class="headerlink" href="#prior-art" title="Permalink to this headline">¶</a></h1>
<p>See comment about crypto wallets, above.</p>
</div>
<div class="section" id="unresolved-questions">
<span id="unresolved-questions"></span><h1>Unresolved questions<a class="headerlink" href="#unresolved-questions" title="Permalink to this headline">¶</a></h1>
<ul class="simple">
<li>What is the relationship between a threading model in pluggable storage and
the threading model of wallets? Is it always legal to be reading and writing
wallets from multiple threads at the same time?</li>
</ul>
</div>


           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, Hyperledger Indy

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
    

  

  <script type="text/javascript" src="../../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>